name: ðŸš€ Deploy to Production

on:
    push:
        branches:
            - main # Trigger only when main branch is updated

jobs:
    deploy:
        name: Deploy via SSH
        runs-on: ubuntu-latest

        steps:
            - name: ðŸ§¾ Checkout repository
              uses: actions/checkout@v4

            - name: ðŸš€ SSH into Server and Deploy
              uses: appleboy/ssh-action@v1.0.3
              with:
                  host: ${{ secrets.SERVER_HOST }}
                  username: ${{ secrets.SERVER_USERNAME }}
                  key: ${{ secrets.SERVER_SSH_KEY }}
                  script_stop: true
                  script: |
                      set -Eeuo pipefail
                      echo "âœ… Connected to server: ${{ secrets.SERVER_HOST }}"

                      APP_DIR="/home/deploy/grahak-microservices/TaskService"  # <-- change this to your app directory
                      cd "$APP_DIR" || { echo "âŒ Directory not found: $APP_DIR"; exit 1; }

                      echo "ðŸ“¦ Fetching latest code..."
                      git fetch --all --prune
                      git reset --hard origin/main

                      echo "ðŸ§¹ Stopping old containers..."
                      docker compose down --remove-orphans

                      echo "ðŸ”§ Rebuilding and starting containers..."
                      docker compose up -d --build

                      echo "ðŸ©º Checking container status..."
                      docker ps --format "table {{.Names}}\t{{.Status}}"

                      echo "âœ… Deployment completed successfully."
